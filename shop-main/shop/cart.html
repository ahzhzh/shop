<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>장바구니</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/slick.css"/>
    <link type="text/css" rel="stylesheet" href="css/slick-theme.css"/>
    <link type="text/css" rel="stylesheet" href="css/nouislider.min.css"/>
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <link type="text/css" rel="stylesheet" href="css/cart.css"/>
    <!-- voice-search.css 추가 -->
	<link type="text/css" rel="stylesheet" href="css/voice-search.css"/>
</head>
<body>
    <!-- HEADER -->
    <header>
	
        <!-- MAIN HEADER -->
        <div id="header">
            <!-- container -->
            <div class="container">
                <!-- row -->
                <div class="row">
                    <!-- LOGO -->
                    <div class="col-md-3">
                        <div class="header-logo">
                            <a href="index.html" class="logo">
                                <img src="./img/logo.png" alt="">
                            </a>
                        </div>
                    </div>
                    <!-- /LOGO -->

                    <!-- SEARCH BAR -->
                    <div class="col-md-6">
                        <div class="header-search">
                            <form>
                                <select class="input-select">
                                    <option value="0">All Categories</option>
                                    <option value="1">Category 01</option>
                                    <option value="1">Category 02</option>
                                </select>
                                <input class="input" placeholder="검색어를 입력하세요.">
                                <button class="search-btn">검색</button>
                            </form>
                        </div>
                    </div>
                    <!-- /SEARCH BAR -->

                    <!-- ACCOUNT -->
                    <div class="col-md-3 clearfix">
                        <div class="header-ctn">
                            <!-- Voice Search -->
                            <div>
                                <a href="#" id="voice-search-btn">
                                    <i class="fa fa-microphone"></i>
                                    <span>음성</span>
                                </a>
                            </div>
                            <!-- /Voice Search -->


                            

                            <!-- Cart -->
                            <div class="dropdown">
                                <a href="cart.html">
                                    <i class="fa fa-shopping-cart"></i>
                                    <span>장바구니</span>
                                    <div class="qty" id="cart-count">0</div>
                                </a>
                            </div>
                            <!-- /Cart -->

                            <!-- Menu Toogle -->
                            <div class="menu-toggle">
                                <a href="#">
                                    <i class="fa fa-bars"></i>
                                    <span>Menu</span>
                                </a>
                            </div>
                            <!-- /Menu Toogle -->
                        </div>
                    </div>
                    <!-- /ACCOUNT -->
                </div>
                <!-- row -->
            </div>
            <!-- container -->
        </div>
        <!-- /MAIN HEADER -->
    </header>
    <!-- /HEADER -->

    <!-- NAVIGATION -->
		<nav id="navigation">
			<!-- container -->
			<div class="container">
				<!-- responsive-nav -->
				<div id="responsive-nav">
					<!-- NAV -->
					<ul class="main-nav nav navbar-nav">
						<li><a href="index.html">메인</a></li>
						<li><a href="index.html#hot-deal">인기 상품</a></li>
						<li><a href="index.html#NEW">NEW</a></li>
						<li><a href="index.html#board">PC</a></li>
						<li><a href="index.html#graphics">PC 부품</a></li>
						<li><a href="index.html#PC">주변 기기</a></li>
					</ul>
					<!-- /NAV -->
				</div>
				<!-- /responsive-nav -->
			</div>
			<!-- /container -->
		</nav>
		<!-- /NAVIGATION -->

    <!-- 장바구니 섹션 -->
    <div id="breadcrumb" class="section">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h3 class="breadcrumb-header">장바구니</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="cart-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>상품</th>
                                    <th>가격</th>
                                    <th>수량</th>
                                    <th>합계</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items">
                                <!-- 장바구니 아이템들이 여기에 동적으로 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4 col-md-offset-8">
                    <div class="cart-summary">
                        <h3>장바구니 합계</h3>
                        <div class="cart-total">
                            <strong>총 금액:</strong>
                            <span id="cart-total">₩0</span>
                        </div>
                        <a href="checkout.html" class="primary-btn order-submit">결제하기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
		<footer id="footer">
			<!-- top footer -->
			<div class="section">
				<!-- container -->
				<div class="container">
					<!-- row -->
					<div class="row">
						

						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">Categories</h3>
								<ul class="footer-links">
									<li><a href="#">인기 상품</a></li>
									<li><a href="#">NEW</a></li>
									<li><a href="#">PC 부품</a></li>
									<li><a href="#">PC</a></li>
									<li><a href="#">주변 기기</a></li>
								</ul>
							</div>
						</div>

						<div class="clearfix visible-xs"></div>

						

						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">Service</h3>
								<ul class="footer-links">
									<li><a href="#">장바구니</a></li>
									<li><a href="#">결제</a></li>
									<li><a href="#">도움</a></li>
								</ul>
							</div>
						</div>
					</div>
					<!-- /row -->
				</div>
				<!-- /container -->
			</div>
			<!-- /top footer -->

			<!-- bottom footer -->
			<div id="bottom-footer" class="section">
				<div class="container">
					
				</div>
				<!-- /container -->
			</div>
			<!-- /bottom footer -->
		</footer>
		<!-- /FOOTER -->

    <!-- jQuery Plugins -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/slick.min.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/jquery.zoom.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>

        <!-- 음성 인식 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 이전 페이지에서 음성 인식 상태 확인
        const wasListening = sessionStorage.getItem('voiceRecognitionActive') === 'true';
        
        const voiceSearchBtn = document.getElementById('voice-search-btn');
        const searchInput = document.querySelector('.header-search input.input');
        let isListening = false;
        let ws = null;
        let audioContext = null;
        let mediaStreamSource = null;
        let processor = null;
        let lastAudioTime = Date.now();
        let autoStopTimer;
    
        // 이전 페이지에서 음성 인식 중이었다면 자동으로 시작
        if (wasListening) {
            setTimeout(() => {
                startListening();
            }, 1000); // 페이지 로드 후 1초 후에 시작
        }
    
        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 48000,
                        channelCount: 1
                    }
                });
    
                audioContext = new AudioContext();
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                processor = audioContext.createScriptProcessor(16384, 1, 1);
    
                processor.onaudioprocess = (e) => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    
                    // 음성이 감지되었는지 확인
                    const soundDetected = inputData.some(value => Math.abs(value) > 100);
                    
                    if (soundDetected) {
                        lastAudioTime = Date.now();
                    }
    
                    // 오디오 데이터를 서버에 전송
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        try {
                            const int16Array = convertFloat32ToInt16(inputData);
                            const base64Audio = btoa(String.fromCharCode(...new Uint8Array(int16Array.buffer)));
                            
                            ws.send(JSON.stringify({
                                type: 'audio',
                                audio: base64Audio
                            }));
                            
                        } catch (error) {
                            console.error('Error sending audio data:', error);
                        }
                    }
                };
    
                mediaStreamSource.connect(processor);
                processor.connect(audioContext.destination);
    
                console.log('Audio processing started');
                startWebSocket();
                isListening = true;
                voiceSearchBtn.classList.add('listening');
                sessionStorage.setItem('voiceRecognitionActive', 'true');
    
                autoStopTimer = setInterval(() => {
                    if (Date.now() - lastAudioTime > 60000) {
                        stopListening('1분 동안 음성이 감지되지 않아 종료합니다.');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                }, 1000);
    
            } catch (error) {
                console.error('마이크 접근 오류:', error);
                alert('마이크 접근이 거부되었습니다.');
            }
        }
    
        function startWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:3001`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected to:', wsUrl);
                ws.send(JSON.stringify({ type: 'start' }));
            };
    
            ws.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    let silenceTimeout = null;
    
                    if (data.type === 'interim') {
                        console.log('Interim transcript:', data.transcript);
                        searchInput.value = data.transcript;
                        // 중간 결과가 수신될 때마다 타이머 리셋
                        if (silenceTimeout) clearTimeout(silenceTimeout);
                        silenceTimeout = setTimeout(async () => {
                            // 3초 동안 새로운 중간 결과가 없으면 현재 결과를 최종으로 처리
                            if (data.transcript.trim()) {  // 빈 문자열이 아닌 경우에만 처리
                                const finalTranscript = data.transcript;
                                console.log('Final transcript (from silence):', finalTranscript);
                                
                                // 서버에 최종 결과 전송
                                if (ws && ws.readyState === WebSocket.OPEN) {
                                    ws.send(JSON.stringify({
                                        type: 'final',
                                        transcript: finalTranscript
                                    }));
                                }
                            }
                        }, 3000);  // 3초 대기
                    } else if (data.type === 'result') {
                        console.log('Final transcript:', data.transcript);
                        searchInput.value = data.transcript;
                        
                        const text = data.transcript.toLowerCase();
                        if (text.includes('결제') || text.includes('주문') || text.includes('구매')) {
                            const checkoutBtn = document.querySelector('.order-submit');
                            if (checkoutBtn) {
                                if (data.audio) {
                                    const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                                    audio.onended = () => {
                                        checkoutBtn.click();
                                    };
                                    await audio.play();
                                } else {
                                    checkoutBtn.click();
                                }
                            }
                        } else if (text.includes('뒤로') || text.includes('이전')) {
                            if (data.audio) {
                                const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                                audio.onended = () => {
                                    window.history.back();
                                };
                                await audio.play();
                            } else {
                                window.history.back();
                            }
                        } else if (text.includes('꺼 줘') || text.includes('종료') || text.includes('그만')) {
                            if (data.audio) {
                                const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                                audio.onended = () => {
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1000);
                                };
                                await audio.play();
                            }
                        }
    
                        if (data.audio) {
                            const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                            await audio.play();
                        }
                    }
                } catch (error) {
                    console.error('WebSocket message processing error:', error);
                }
            };
    
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
    
            ws.onclose = () => {
                console.log('WebSocket closed');
            };
        }
    
        function stopListening(message = '음성 인식을 종료합니다.') {
            if (isListening) {
                if (autoStopTimer) {
                    clearInterval(autoStopTimer);
                    autoStopTimer = null;
                }
    
                if (ws) {
                    ws.send(JSON.stringify({ type: 'stop' }));
                    ws.close();
                }
                
                if (processor) {
                    processor.disconnect();
                    mediaStreamSource.disconnect();
                    audioContext.close();
                }
    
                isListening = false;
                voiceSearchBtn.classList.remove('listening');
                sessionStorage.removeItem('voiceRecognitionActive');
                
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'ko-KR';
                speechSynthesis.speak(utterance);
            }
        }
    
        function convertFloat32ToInt16(float32Array) {
            const int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return int16Array;
        }
    
        voiceSearchBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (!isListening) {
                startListening();
            } else {
                stopListening();
            }
        });
    
        // 페이지를 떠날 때 WebSocket 연결 정리
        window.addEventListener('beforeunload', () => {
            if (isListening) {
                if (ws) {
                    ws.close();
                }
            }
        });
    });
    </script>



    <script>
        // 장바구니 아이템을 표시하는 함수
        function displayCartItems() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const checkoutButton = document.querySelector('.order-submit');
            let total = 0;

            cartItemsContainer.innerHTML = '';
            
            // 장바구니가 비어있는지 확인
            if (!cartItems || cartItems.length === 0) {
                checkoutButton.onclick = function(e) {
                    e.preventDefault();
                    alert('장바구니가 비어있습니다.');
                };
            } else {
                // 장바구니에 상품이 있을 때는 기본 동작 유지
                checkoutButton.onclick = null;
                
                cartItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="product-widget">
                                <div class="product-img">
                                    <img src="${item.image}" alt="">
                                </div>
                                <div class="product-body">
                                    <h3 class="product-name"><a href="#">${item.name}</a></h3>
                                </div>
                            </div>
                        </td>
                        <td>₩${item.price.toLocaleString()}</td>
                        <td>
                            <div class="input-number">
                                <input type="number" value="${item.quantity}">
                                <span class="qty-up">+</span>
                                <span class="qty-down">-</span>
                            </div>
                        </td>
                        <td>₩${(item.price * item.quantity).toLocaleString()}</td>
                        <td>
                            <button class="delete" onclick="removeFromCart(${item.id})"><i class="fa fa-close"></i></button>
                        </td>
                    `;
                    cartItemsContainer.appendChild(row);
                    total += item.price * item.quantity;
                });
            }

            cartTotal.textContent = `₩${total.toLocaleString()}`;
        }

        // 페이지 로드 시 장바구니 아이템 표시
        window.addEventListener('load', displayCartItems);
    </script>


    
</body>
</html>